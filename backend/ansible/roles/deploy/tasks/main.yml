---
- name: Ensure kubectl is configured
  command: kubectl cluster-info
  register: kube_check
  failed_when: kube_check.rc != 0
  changed_when: false

- name: Create namespace
  k8s:
    state: present
    definition: "{{ lookup('file', '../k8s/namespace.yml') | from_yaml }}"

- name: Create all secrets
  include_tasks: create-secrets.yml

- name: Deploy databases
  block:
    - name: Deploy MySQL for Auth
      k8s:
        state: present
        src: ../k8s/mysql-auth.yml
        namespace: auction-system

    - name: Deploy MySQL for Auction
      k8s:
        state: present
        src: ../k8s/mysql-auction.yml
        namespace: auction-system

    - name: Deploy MySQL for Bidding
      k8s:
        state: present
        src: ../k8s/mysql-bidding.yml
        namespace: auction-system
  when: "'database' in ansible_run_tags"

- name: Deploy Eureka Server
  k8s:
    state: present
    src: ../k8s/eureka-service/deployment.yml
    namespace: auction-system

- name: Wait for Eureka to be ready
  k8s_info:
    kind: Pod
    namespace: auction-system
    label_selectors:
      - app = eureka-server
    wait: yes
    wait_timeout: 120

- name: Deploy all microservices
  include_tasks: deploy-services.yml